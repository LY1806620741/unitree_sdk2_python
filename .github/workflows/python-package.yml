# This workflow will install Python dependencies, run tests and lint with a variety of Python versions
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Python package

on:
  workflow_dispatch:

jobs:
  build:

    runs-on: windows-latest
    env:
      VERSION: 0.10.x
      CIBW_BUILD: 311-*
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]

    steps:
      # 初始化
    - uses: actions/checkout@v4

    # 配置python
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}

    # 初始化制品收集目录
    - name: init dist
      run: |
        mkdir dist

    # 准备构建python wheel包
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build

    # 由于cyclonedds-python暂时没有提供python3.11 顺带也编译了 issue:https://github.com/eclipse-cyclonedds/cyclonedds-python/issues/221
    - name: build cyclonedds-python
      run: |
        git clone https://github.com/eclipse-cyclonedds/cyclonedds-python -b releases/${{ env.VERSION }} --depth=1
        cd cyclonedds-python
        (Get-Content pyproject.toml) -replace 'https://github.com/eclipse-cyclonedds/cyclonedds.git','https://github.com/eclipse-cyclonedds/cyclonedds -b releases/${{ env.VERSION }} --depth=1' | Set-Content pyproject.toml
        (Get-Content setup.py) -replace '(?<="Programming Language :: Python :: 3.10",.*?)', "`n        `"Programming Language :: Python :: 3.11`","  | Set-Content setup.py"
        pip install --user cibuildwheel==2.8.*
        python -m cibuildwheel --output-dir wheelhouse .
        tar zcvf  cyclonedds.tar.gz -C cyclonedds-build .
      shell: pwsh

    # 构建宇树python sdk本身
    - name: build package
      run: |
        set CYCLONEDDS_HOME=${{ github.workspace }}/cyclonedds/install
        python -m build --wheel
      shell: cmd

    # 收集构建产物
    - name: collect binary
      run: |
        mv ${{ github.workspace }}/cyclonedds-python/cyclonedds.tar.gz dist/cyclonedds_${{ env.VERSION }}_winx64.tar.gz
        mv ${{ github.workspace }}/cyclonedds-python/wheelhouse/* dist/
        mv ${{ github.workspace }}/dist/* dist/

    # 上传到工作流制品库
    - name: upload package and dependency
      uses: actions/upload-artifact@v4
      with:
        name: unitree_sdk2_python${{ matrix.python-version }}_${{ env.VERSION }}_winx64
        path:  |
          dist/*

